[FIELD]
FIELD(1).NAME="TagName"
FIELD(2).NAME="Value"
FIELD(2).TYPE="Number"
FIELD(3).NAME="TimeStamp"
FIELD(3).TYPE="DateTime"
FIELD(3).FORMAT="SECONDS_GMT"


FIELD(4).NAME="Variable_String"

FIELD(5).NAME="weather"

FIELD(6).NAME="WeatherId"

FIELD(5).NAME="coord"

FIELD(6).NAME="coordLon"

FIELD(7).NAME="TagPrefix"

FIELD(8).NAME="StaticAttributes"
FIELD(8).TYPE="Collection"

FIELD(9).NAME="DynamicAttributes"
FIELD(9).TYPE="COllection"

FIELD(10).NAME="CityName"

FIELD(11).NAME="CountryName"

FIELD(12).NAME="main"
FIELD(13).NAME="wind"
FIELD(14).NAME="sys"
FIELD(15).NAME="clouds"

FIELD(16).NAME="TemplateVersion"


[MSG]
MSG(1).NAME="Data"
 
[Data]
Data.FILTER=C1=="*"

TemplateVersion = "4"

print("A new request")
print(__MESSAGE)
print(__STREAMINFO)
print(TemplateVersion)


StaticAttributes = Clear()
DynamicAttributes = Clear()

' Metadata and timestamp
TagPrefix = "OpenWeather." + JsonGetValue(__MESSAGE, "id") + ".Weather."
CityName = JsonGetValue(__Message, "name")
CountryName = JsonGetValue(JsonGetValue(__Message, "sys"), "country")

StaticAttributes = Add("id", JsonGetValue(__MESSAGE, "id"))

TimeStamp = JsonGetValue(__MESSAGE, "dt")
StoreElement(CountryName + TemplateVersion, "Country" + TemplateVersion)

'Coordinate data
coord = JsonGetValue(__MESSAGE, "coord")
StaticAttributes = Add("Longitude", JsonGetValue(coord, "lon"))
StaticAttributes = Add("Latitude", JsonGetValue(coord, "lat"))

StaticAttributes = Add("Timezone", JsonGetValue(__MESSAGE, "timezone"))

' weather condition
FOREACH (JsonGetItem(__MESSAGE, "weather[]")) DO
   WeatherId = JsonGetValue(__ITEM, "id")
ENDFOR
StoreEvent(TagPrefix + "Weather.id", "Weather condition id", TimeStamp, WeatherId )
DynamicAttributes = Add("Weather condition id")

' Weather
main = JsonGetValue(__MESSAGE,"main")

StoreEvent(TagPrefix + "main.temp", "Temperature", TimeStamp, JsonGetValue(main,"temp"))
print("Temperature reading")
print(JsonGetValue(main,"temp"))

StoreEvent(TagPrefix + "main.pressure", "Pressure", TimeStamp, JsonGetValue(main,"pressure") )
StoreEvent(TagPrefix + "main.humdity", "Humidity", TimeStamp, JsonGetValue(main,"humidity") )
StoreEvent(TagPrefix + "main.temp_min", "Minimum temperature", TimeStamp, JsonGetValue(main,"temp_min") )
StoreEvent(TagPrefix + "main.temp_max", "Maximum temperature", TimeStamp, JsonGetValue(main,"temp_max") )

DynamicAttributes = Add("Temperature")
DynamicAttributes = Add("Pressure")
DynamicAttributes = Add("Humidity")
DynamicAttributes = Add("Minimum temperature")
DynamicAttributes = Add("Maximum temperature")

' visibility
StoreEvent(TagPrefix + "visibility", "Visibility", TimeStamp, JsonGetValue(__MESSAGE,"visibility") )

DynamicAttributes = Add("Visibility")

'Wind
wind = JsonGetValue(__MESSAGE,"wind")

StoreEvent(TagPrefix + "wind.speed", "Wind Speed", TimeStamp, JsonGetValue(wind,"speed"))
StoreEvent(TagPrefix + "main.pressure", "Wind Direction", TimeStamp, JsonGetValue(wind,"deg") )

DynamicAttributes = Add("Wind Speed")
DynamicAttributes = Add("Wind Direction")

'Cloud
clouds = JsonGetValue(__MESSAGE,"clouds")

StoreEvent(TagPrefix + "clouds.all", "Cloudiness", TimeStamp, JsonGetValue(clouds,"all"))

DynamicAttributes = Add("Cloudiness")

'Rain
' Rain and snow are optional

'Sunrise/sunset
sys = JsonGetValue(__MESSAGE,"sys")

StoreEvent(TagPrefix + "sys.sunrise", "Sunrise", TimeStamp, JsonGetValue(sys,"sunrise"))
StoreEvent(TagPrefix + "sys.sunset",  "Sunset",  TimeStamp, JsonGetValue(sys,"sunset") )
print("sunset reading")
print(JsonGetValue(sys,"sunset"))

DynamicAttributes = Add("Sunrise")
DynamicAttributes = Add("Sunset")

print(StaticAttributes)

print(DynamicAttributes)

StoreElement(CountryName + TemplateVersion + CHAR(92) + CityName + TemplateVersion, "City" + TemplateVersion, DynamicAttributes, StaticAttributes)