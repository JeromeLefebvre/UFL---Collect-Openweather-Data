[FIELD]
FIELD(3).NAME="TimeStamp"
FIELD(3).TYPE="DateTime"
FIELD(3).FORMAT="SECONDS_GMT"

FIELD(4).NAME="coord"
FIELD(5).NAME="weather"
FIELD(6).NAME="WeatherId"
FIELD(7).NAME="TagPrefix"
FIELD(8).NAME="StaticAttributes"
FIELD(8).TYPE="Collection"
FIELD(10).NAME="CityName"
FIELD(11).NAME="CountryName"
FIELD(12).NAME="main"
FIELD(13).NAME="wind"
FIELD(14).NAME="sys"
FIELD(15).NAME="clouds"
FIELD(16).NAME="TemplateVersion"

[MSG]
MSG(1).NAME="Data"
 
[Data]
Data.FILTER=C1=="*"

TemplateVersion = "5"

StaticAttributes = Clear()

' Metadata and timestamp
TagPrefix = "OpenWeather." + JsonGetValue(__MESSAGE, "id") + ".Weather."
CityName = JsonGetValue(__Message, "name")
CountryName = JsonGetValue(JsonGetValue(__Message, "sys"), "country")
TimeStamp = JsonGetValue(__MESSAGE, "dt")

StaticAttributes = Add("id", JsonGetValue(__MESSAGE, "id"))
StaticAttributes = Add("Timezone", JsonGetValue(__MESSAGE, "timezone"))
StaticAttributes = Add("City Name", JsonGetValue(__MESSAGE, "name"))

StoreElement(CountryName + TemplateVersion, "Country" + TemplateVersion)

'Coordinate
coord = JsonGetValue(__MESSAGE, "coord")
StaticAttributes = Add("Longitude", JsonGetValue(coord, "lon"))
StaticAttributes = Add("Latitude", JsonGetValue(coord, "lat"))


' weather condition
FOREACH (JsonGetItem(__MESSAGE, "weather[]")) DO
   StoreEvent(TagPrefix + "Weather.id", , TimeStamp, JsonGetValue(__ITEM, "id") )
ENDFOR

' Weather
main = JsonGetValue(__MESSAGE,"main")
StoreEvent(TagPrefix + "main.temp", , TimeStamp, JsonGetValue(main,"temp"))
StoreEvent(TagPrefix + "main.pressure", , TimeStamp, JsonGetValue(main,"pressure") )
StoreEvent(TagPrefix + "main.humidity", , TimeStamp, JsonGetValue(main,"humidity") )
StoreEvent(TagPrefix + "main.temp_min", , TimeStamp, JsonGetValue(main,"temp_min") )
StoreEvent(TagPrefix + "main.temp_max", , TimeStamp, JsonGetValue(main,"temp_max") )

' visibility
StoreEvent(TagPrefix + "visibility", "Visibility", TimeStamp, JsonGetValue(__MESSAGE,"visibility") )

'Wind
wind = JsonGetValue(__MESSAGE,"wind")
StoreEvent(TagPrefix + "wind.speed", , TimeStamp, JsonGetValue(wind,"speed"))
StoreEvent(TagPrefix + "wind.deg", , TimeStamp, JsonGetValue(wind,"deg"))

'Cloud
clouds = JsonGetValue(__MESSAGE,"clouds")
StoreEvent(TagPrefix + "clouds.all", , TimeStamp, JsonGetValue(clouds,"all"))

'Rain
' Rain and snow are optional

'Sunrise/sunset
sys = JsonGetValue(__MESSAGE,"sys")

StoreEvent(TagPrefix + "sys.sunrise", , TimeStamp, JsonGetValue(sys,"sunrise"))
StoreEvent(TagPrefix + "sys.sunset",  ,  TimeStamp, JsonGetValue(sys,"sunset") )


StoreElement(CountryName + TemplateVersion + CHAR(92) + CityName + TemplateVersion, "City" + TemplateVersion, , StaticAttributes)


